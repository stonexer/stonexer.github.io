<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  前端 Polyfill 方案 - SToneX
  
  </title>
  
  
  <link href="atom.xml" rel="alternate" title="SToneX" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />
    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
  <script src="asset/highlightjs/highlight.pack.js"></script>
  <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
  function before_search(){
    var searchVal = 'site:www.sitixi.com ' + document.getElementById('search_input').value;
    document.getElementById('search_q').value = searchVal;
    return true;
  }
</script>
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>


  <section class="top-bar-section">
  <div class="row">
      <div style="position: relative;width:100%;"><div style="position: absolute; width:100%;">
        <ul id="main-menu" class="left">
        
        <li id=""><a target="self" href="index.html">Home</a></li>
        
        <li id=""><a target="_self" href="archives.html">Archives</a></li>
        
        </ul>

        <ul class="right" id="search-wrap">
          <li>
<form target="_blank" onsubmit="return before_search();" action="http://google.com/search" method="get">
    <input type="hidden" id="search_q" name="q" value="" />
    <input tabindex="1" type="search" id="search_input"  placeholder="Search"/>
</form>
</li>
          </ul>
      </div></div>
  </div>
  </section>

</nav>

        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; SToneX</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
       
       <li><a href="index.html">HOME</a></li>
    <li><a href="archives.html">Archives</a></li>
    <li><a href="about.html">ABOUT</a></li>

    <li><label>Categories</label></li>

         

      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>


        <section id="main-content" role="main" class="scroll-container">
        
       

 <script type="text/javascript">
  $(function(){
    $('#menu_item_index').addClass('is_active');
  });
</script>
<div class="row">
  <div class="large-8 medium-8 columns">
      <div class="markdown-body article-wrap">
       <div class="article">
          
          <h1>前端 Polyfill 方案</h1>
     
        <div class="read-more clearfix">
          <span class="date">2017/7/8</span>

          
           
         
          <span class="comments">
            

            
          </span>

        </div>
      </div><!-- article -->

      <div class="article-content">
      <p>今天是 2017 年 7 月 7 日，es2015 正式发布已经两年了。但最新的浏览器们逼近 100% 的支持率对我们好像并没有什么卵用，为了少数用户的体验，我们很可能需要兼容 IE9。感谢 babel 的编译，让我们完美的提前使用上了 const，let 和 arrow function。可也许你还是面对着不敢直接使用 <code>fetch</code> 或是 <code>Object.assign</code> 的难题？</p>

<h2 id="toc_0">babel 和 babel-polyfill</h2>

<p>刚接触 babel 的同学一开始可能都认为在使用了 babel 后就可以无痛的使用 es2015 了，之后被各种 undefined 的报错无情打脸。一句话概括, babel 的编译不会做 polyfill。那么 polyfill 是指什么呢?</p>

<pre><code class="language-javascript">const foo = (a, b) =&gt; {
    return Object.assign(a, b);
};
</code></pre>

<p>当我们写出上面这样的代码，交给 babel 编译时，我们得到了：</p>

<pre><code>&quot;use strict&quot;;

var foo = function foo(a, b) {
    return Object.assign(a, b);
};
</code></pre>

<p>arrow function 被编译成了普通的函数，但仔细一看 <code>Object.assign</code> 还牢牢的站在那里，而它作为 es2015 的新方法，并不能运行在相当多的浏览器上。为什么不把 Object.assign 编译成 <code>(Object.assign||function() { /*...*/})</code> 这样的替代方法呢？好问题！编译为了保证正确的语义只能转换语法而不是去增加或修改原有的属性和方法，而这种使用替代方法的操作我们叫它 polyfill。</p>

<p>babel 直接提供了兼容 es2015 所有方法的 <a href="https://babeljs.io/docs/usage/polyfill/">babel-polyfill</a>，安装 <code>babel-polyfill</code> 后你只需要在所有代码的最前面加一句便可引入它:</p>

<pre><code class="language-javascript">import &#39;babel-polyfill&#39;;

export const foo = (a, b) =&gt; Object.assign(a, b);
</code></pre>

<p>方便你尝试，这里准备了一些测试的<a href="https://github.com/stonexer/babel-polyfill-test">代码</a>。打包好的 pollyfill.js 251kb，（建议拉下来代码实际跑一下，之后提到的所有方式的代码也都可以看到结果）搜索一下 polyfill.js 不难找到 <code>$export($export.S + $export.F, &#39;Object&#39;, {assign: __webpack_require__(79)});</code> 这样的全局修改。非常不准确但大致意思是：</p>

<pre><code>//polyfill
Object.assign=Object.assign||function assign(){};

// your code
var foo = exports.foo = function foo(a, b) {
  return Object.assign(a, b);
};
</code></pre>

<p>babel-polyfill 便可以自动在代码前插入所有的 polyfill 代码，为你的程序打造一个完美的 es2015 运行环境。babel 建议直接在网页程序里使用它，大部分的前端 polyfill 方案也都是直接使用它。只要不在意它略有点大的体积（min 后 86kb），直接用它肯定是最稳妥的。值得注意的是，babel-polyfill 带来的改变是全局的，所以无需多次引用，也有可能因此产生冲突，所以最好还是把它抽成一个 common module，放在项目 的 vendor 里，或者干脆直接抽成一个文件放在 cdn 上。</p>

<h2 id="toc_1">babel-runtime &amp; babel-plugin-transform-runtime</h2>

<p>如果你是在开发一个库或者框架，那么 min 之后 86kb 就有点大了，尤其是可能目前能想到要用的只有个 <code>Object.assign</code> 的时候。更可怕的是改变全局是使不得的，谁也不希望用了你的库，还附带了一家老小的 polyfill。鉴于这样的考虑，babel 提供了 runtime transform。</p>

<p>安装和使用的方法同样不复杂，首先需要安装开发时的依赖 <code>babel-plugin-transform-runtime</code>：</p>

<pre><code class="language-shell">yarn add -D babel-plugin-transform-runtime
</code></pre>

<p>同时还需要安装生产环境的依赖 <code>babel-runtime</code>。是否要在生产环境也依赖它取决于你部署代码的方式，简单点直接放在 dependency 里总没错。</p>

<pre><code class="language-shell">yarn add babel-runtime
</code></pre>

<p>然后就是添加这个 plugin 到 babelrc 里。一切就绪，它会自动从 <code>core-js</code> 引入你用到的方法。但自动就意味着不精确：</p>

<pre><code class="language-javascript">export const foo = (a, b) =&gt; Object.assign(a, b);

export const bar = (a, b) =&gt; {
    const o = Object;
    return o.assign(a, b);
};
</code></pre>

<p>会输出成：</p>

<pre><code>var foo = exports.foo = function foo(a, b) {
    return (0, _assign2.default)(a, b);
};

var bar = exports.bar = function bar(a, b) {
    var o = Object;
    return o.assign(a, b);
};
</code></pre>

<p>foo 中的 assign 会被替换成 import 来得方法，而 bar 中这样的调用则无能为力了。</p>

<p>同时，因为 transform runtime 的 polyfill 不是全局的，因此实例化的对象方法则不能被 polyfill，比如 <code>[1,2,3].includes</code> 这样依赖于全局 <code>Array.prototype.includes</code> 的调用依然无法 polyfill。</p>

<h2 id="toc_2">babel-preset-env</h2>

<p>回到应用开发。借助自动 polyfill 来优化看来是不太靠谱的，那是不是就无从优化了呢？并不是。还记得 babel 推荐使用的 babel-preset-env 么？它根据指定的环境判断需要做哪些编译。而在张克炎大神的<a href="https://github.com/babel/babel-preset-env/issues/20">建议</a>下，babel-preset-env 也支持针对环境选择需要的 polyfill 了，对比下 &quot;IE &gt;= 9&quot; 和 &quot;chrome &gt;= 59&quot; 下环境的文件大小:</p>

<pre><code>       Asset     Size  Chunks                    Chunk Names
 polyfill.js   251 kB       0  [emitted]  [big]  polyfill
      ie9.js   189 kB       1  [emitted]         ie9
   chrome.js  30.5 kB       2  [emitted]         chrome
transform.js  17.2 kB       3  [emitted]         transform
</code></pre>

<p>在目前 IE9 的需求下能节省到将近 30%，但想不到浏览器之神 chrome 也还需要 30kb 的 polyfill，可能是为了修正那些 v8 的一些细小的规范问题吧。（当我尝试调大浏览器范围时，发现始终停留在 189kb 以内，还没细究相比完整的 polyfill 少掉了什么，如果有高手知道的欢迎解答）</p>

<h2 id="toc_3">polyfill.io</h2>

<p>以上这样对你来说应该已经够用了，但本质上还是牺牲了那些愿意使用最新浏览器的优质用户们。聪明的你可能已经想到了一种优化方案，针对浏览器来选择 polyfill。没错！<a href="https://polyfill.io/v2/docs/">polyfill.io</a> 便是基于这个思路给出的一项服务。</p>

<p>你可以尝试在不同的浏览器下请求 <code>https://cdn.polyfill.io/v2/polyfill.js</code> 这个文件，服务器会判断浏览器 UA 返回不同的 polyfill 文件，你所要做的仅仅是在页面上引入这个文件，polyfill 这件事就自动以最优雅的方式解决了。更加让人喜悦的是，polyfill.io 不旦提供了 cdn 的服务，也开源了自己的实现方案 <a href="https://github.com/Financial-Times/polyfill-service">polyfill-service</a>。简单配置一下，便可拥有自己的 polyfill service 了。</p>

<p>看上去一切都很美好，但在使用之前还请你多考虑一下。polyfill.io 面对国内奇葩的浏览器环境能不能把 UA 算准，如果缺失了 polyfill 还有没有什么补救方案，也许都是你需要考虑的。但无论如何，这是个优秀的想法和方案，我想未来也会有更多的网站采用 polyfill.io 的思路的。比如 <a href="https://www.theguardian.com/international">theguardian</a> 和 <a href="https://github.com/facebookincubator/create-react-app/issues/1104">redux 作者 Dan 在 create-react-app 上的提议</a>（虽然没被接受哈~）。</p>


    

      </div>

      <div class="row">
        <div class="large-6 columns">
        <p class="text-left" style="padding:15px 0px;">
      
        </p>
        </div>
        <div class="large-6 columns">
      <p class="text-right" style="padding:15px 0px;">
      
          <a  href="14827149741341.html" 
          title="Next Post: Vuex 源码阅读">Vuex 源码阅读 &raquo;</a>
      
      </p>
        </div>
      </div>
      <div class="comments-wrap">
        <div class="share-comments">
          

          

          
        </div>
      </div>
    </div><!-- article-wrap -->
  </div><!-- large 8 -->




 <div class="large-4 medium-4 columns">
  <div class="hide-for-small">
    <div id="sidebar" class="sidebar">
          <div id="site-info" class="site-info">
            
                <h1>SToneX</h1>
                <div class="site-des"></div>
                <div class="social">











  <a target="_blank" class="rss" href="atom.xml" title="RSS">RSS</a>
                
              	 </div>
          	</div>

             

              <div id="site-categories" class="side-item ">
                <div class="side-header">
                  <h2>Categories</h2>
                </div>
                <div class="side-content">

      	<p class="cat-list">
         
        </p>


                </div>
              </div>

              <div id="site-categories" class="side-item">
                <div class="side-header">
                  <h2>Recent Posts</h2>
                </div>
                <div class="side-content">
                <ul class="posts-list">
	      
		      
			      <li class="post">
			        <a href="14994835126345.html">前端 Polyfill 方案</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="14827149741341.html">Vuex 源码阅读</a>
			      </li>
		     
		   
		  		</ul>
                </div>
              </div>
        </div><!-- sidebar -->
      </div><!-- hide for small -->
</div><!-- large 4 -->

</div><!-- row -->

 <div class="page-bottom clearfix">
  <div class="row">
   <p class="copyright">Copyright &copy; 2015
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
</div>

        </section>
      </div>
    </div>

  
    

    <script src="asset/js/foundation.min.js"></script>
    <script>
      $(document).foundation();
      function fixSidebarHeight(){
        var w1 = $('.markdown-body').height();
          var w2 = $('#sidebar').height();
          if (w1 > w2) { $('#sidebar').height(w1); };
      }
      $(function(){
        fixSidebarHeight();
      })
      $(window).load(function(){
          fixSidebarHeight();
      });
     
    </script>

    



  </body>
</html>
